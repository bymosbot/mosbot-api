# Database Migrations

## Current Schema

The database schema is consolidated into a single initial migration:

- `000_create_migrations_table.sql` - Creates the migrations tracking table
- `001_initial_schema.sql` - Complete database schema with all features

## Migration 001 Features

The consolidated `001_initial_schema.sql` includes:

### Tables

- **users** - User accounts with role-based access (owner, agent, admin [deprecated], user)
- **tasks** - Task management with full feature set
- **task_comments** - Per-task discussion threads
- **task_dependencies** - Task blocking relationships
- **activity_logs** - System-wide activity tracking
- **task_logs** - Per-task audit trail

### Task Features

- Task numbering (TASK-1, TASK-2, etc.)
- Parent/child relationships (epics and subtasks)
- Dependencies with circular detection
- Agent usage tracking (cost, tokens, model)
- Preferred model selection
- Comments with event logging
- Full audit trail

### Seed Data

Organization users based on org chart:

| User | Email | Role | Password |
| ---- | ----- | ---- | -------- |
| Marcelo Oliveira (CEO) | `ceo@mosbot.local` | `owner` | `admin123` (fixed) |
| MosBot (COO) | `coo@mosbot.local` | `agent` | Auto-generated (random) |
| Elon (CTO) | `cto@mosbot.local` | `agent` | Auto-generated (random) |
| Gary (CMO) | `cmo@mosbot.local` | `agent` | Auto-generated (random) |
| Alex (CPO) | `cpo@mosbot.local` | `agent` | Auto-generated (random) |

**Password Generation:**
- CEO uses fixed password `admin123` for easy owner access
- All AI agent users (with 'agent' role) get secure random passwords (22 characters, base64)
- Passwords are generated by `001_initial_schema.post.js` during migration
- **Credentials are printed to console** during migration - save them securely!

**IMPORTANT:** Change CEO password after first login!

## Old Migrations

Previous incremental migrations have been moved to `_old/` for reference:

- `002_task_comments.sql`
- `003_add_comment_event_types.sql`
- `004_add_task_keys_and_relationships.sql`
- `005_add_task_agent_usage_fields.sql`
- `006_add_task_preferred_model_field.sql`

These are no longer needed as all features are consolidated into `001_initial_schema.sql`.

## Resetting the Database

To reset the database with the new consolidated schema:

```bash
# Drop and recreate the database
docker-compose down
docker volume rm mosbot-api_postgres-data  # or your volume name
docker-compose up -d

# Migrations will run automatically on startup
```

Or manually:

```bash
# Connect to postgres
docker exec -it mosbot-postgres psql -U mosbot -d mosbot

# Drop all tables
DROP SCHEMA public CASCADE;
CREATE SCHEMA public;
GRANT ALL ON SCHEMA public TO mosbot;
GRANT ALL ON SCHEMA public TO public;

# Exit and restart API to run migrations
\q
docker-compose restart api
```
