---
description: Database migration conventions and patterns for schema changes
alwaysApply: false
---

# Database Migrations

Apply when creating or editing migration SQL in `src/db/migrations/` or working with `src/db/runMigrations.js`.

## When to use what

- **schema.sql**: Legacy full schema for reference only. Not used directly by the migration system.
- **src/db/migrations/*.sql**: All schema changes (initial and incremental). Tracked via `schema_migrations` table. Run automatically on API startup via `runMigrations.js`.

## File naming and location

- Migration files live in `src/db/migrations/`.
- Name: `XXX_short_description.sql` (e.g. `001_initial_schema.sql`, `002_add_task_priority.sql`). 
- XXX is a zero-padded 3-digit sequential number (001, 002, 003, etc.).
- Use underscores (not hyphens) in filenames for consistency.

## Idempotency

- Migrations must be safe to run multiple times. Use existence checks before making changes.
- Prefer: `ADD COLUMN IF NOT EXISTS`, `CREATE INDEX IF NOT EXISTS`, `CREATE OR REPLACE FUNCTION`.
- When no built-in exists, use `information_schema` (e.g. check `information_schema.columns` or `information_schema.tables`) inside a `DO $$ ... END $$` block before running DDL.

## Adding NOT NULL columns to existing tables

1. Add column as nullable.
2. Backfill: `UPDATE table SET new_column = <default> WHERE new_column IS NULL`.
3. Set NOT NULL: `ALTER TABLE table ALTER COLUMN new_column SET NOT NULL`.

## Indexes and foreign keys

- Add an index on every new foreign key column (e.g. `CREATE INDEX IF NOT EXISTS idx_<table>_<column> ON <table>(<column>)`).

## Complex migrations

- Wrap multi-step migrations in a transaction (`BEGIN; ... COMMIT;`) so failure rolls back.

## Migration tracking

- All migrations are tracked in the `schema_migrations` table.
- Each migration is recorded with its filename and timestamp when applied.
- The runner (`runMigrations.js`) automatically applies only pending migrations.
- Migrations run in alphabetical order by filename.
- Each migration runs in a transaction; failures are not recorded.

## Related files

- `src/db/runMigrations.js` – Automated migration runner with tracking.
- `src/db/migrations/` – Migration SQL files.
- `src/db/schema.sql` – Legacy full schema (reference only).
- `src/db/pool.js` – Connection pool.
- `src/db/reset.js` – Database reset utility (drops all tables including `schema_migrations`).

For how to run migrations and troubleshoot, see `docs/guides/migration-guide.md`.
